---
dashboard:
  title: OCP4 General Metrics
  timezone: browser
  templating:
    - name: interval
      type: custom
      current:
        text: 1m
        value:
          - 1m
      options:
        - 30s
        - 1m
        - 2m
        - 3m
        - 4m
        - 5m
    # - name: apiserver_instance
    #   type: query
    #   refresh: 2
    #   query: "label_values(apiserver_request_count, instance)"
    # # - name: container_instance
    # #   type: query
    # #   refresh: 2
    # #   multi: true
    # #   includeAll: true
    # #   query: "label_values(container_cpu_usage_seconds_total, instance)"
    # - name: process_name
    #   type: query
    #   refresh: 2
    #   # multi: true
    #   # includeAll: false
    #   query: "label_values(container_fs_reads_total, id)"
  time:
    from: now-1h
    to: now
  rows:
    - title: description row
      height: 50px
      panels:
        - title: scale-ci-grafana
          content: "**This dashboard is provided by scale-ci-grafana and managed via Grafyaml**"
          type: text

    - title: Pods vs QPS
      collapse: true
      height: 200px
      showTitle: true
      panels:
        - title: Pod Count
          type: graph
          fill: 0
          nullPointMode: 'null'
          targets:
            - expr: "sum(kubelet_running_pod_count)"
        - title: QPS by Master
          type: graph
          fill: 0
          nullPointMode: 'null'
          targets:
            - expr: "sum by (instance) (rate(apiserver_request_count{}[$interval]))"
              legendFormat: "{{instance}}"

    - title: etcd Metrics
      collapse: true
      height: 200px
      showTitle: true
      panels:
        - title: Actual database usage
          type: graph
          fill: 0
          nullPointMode: 'null'
          targets:
            - expr: "sum by (instance) (etcd_mvcc_db_total_size_in_use_in_bytes)"
              legendFormat: "{{instance}}"
          yaxes:
            - format: bytes
            - format: short
        - title: Database size including free space waiting for defrag
          type: graph
          fill: 0
          nullPointMode: 'null'
          targets:
            - expr: "sum by (instance) (etcd_debugging_mvcc_db_total_size_in_bytes)"
              legendFormat: "{{instance}}"
          yaxes:
            - format: bytes
            - format: short

    - title: etcd CPU/Mem/IO/Network
      collapse: true
      height: 200px
      showTitle: true
      panels:
        - title: CPU
          type: graph
          fill: 0
          legend:
            alignAsTable: true
            avg: true
            max: true
            min: true
            show: true
            values: true
          nullPointMode: 'null'
          span: 6
          targets:
            # - expr: 'sum by (instance) (rate(container_cpu_usage_seconds_total{container_name=~"etcd",instance=~"$container_instance"}[$interval]))'
            - expr: 'sum by (instance) (rate(container_cpu_usage_seconds_total{container_name=~"etcd"}[$interval]))'
              legendFormat: "{{instance}}"
        - title: Memory
          type: graph
          fill: 0
          legend:
            alignAsTable: true
            avg: true
            max: true
            min: true
            show: true
            total: false
            values: true
          nullPointMode: 'null'
          span: 6
          targets:
            - expr: 'sum by (instance) (container_memory_rss{container_name=~"etcd"})'
              legendFormat: "RSS {{instance}}"
        - title: IO Read
          type: graph
          fill: 0
          legend:
            alignAsTable: true
            avg: true
            max: true
            min: true
            show: true
            values: true
          nullPointMode: 'null'
          span: 6
          targets:
            - expr: 'sum by (instance) (rate(container_fs_reads_total{container_name=~"etcd"}[$interval]))'
              legendFormat: "Reads {{instance}}"
        - title: IO Write
          type: graph
          fill: 0
          legend:
            alignAsTable: true
            avg: true
            max: true
            min: true
            show: true
            values: true
          nullPointMode: 'null'
          span: 6
          targets:
            - expr: 'sum by (instance) (rate(container_fs_writes_total{container_name=~"etcd"}[$interval]))'
              legendFormat: "Writes {{instance}}"
        - title: Network Receive
          type: graph
          fill: 0
          legend:
            alignAsTable: true
            avg: true
            max: true
            min: true
            show: true
            values: true
          nullPointMode: 'null'
          span: 6
          targets:
            - expr: 'sum by (instance) (rate(container_network_receive_bytes_total{pod_name=~"master-etcd-.*"}[$interval])) / 125000'
              legendFormat: "RX {{instance}}"
        - title: Network Transmit
          type: graph
          fill: 0
          legend:
            alignAsTable: true
            avg: true
            max: true
            min: true
            show: true
            values: true
          nullPointMode: 'null'
          span: 6
          targets:
            - expr: 'sum by (instance) (rate(container_network_transmit_bytes_total{pod_name=~"master-etcd-.*"}[$interval])) / 125000'
              legendFormat: "TX {{instance}}"

    - title: docker CPU/Mem/IO
      collapse: true
      height: 200px
      showTitle: true
      panels:
        - title: CPU
          type: graph
          fill: 0
          legend:
            alignAsTable: true
            avg: true
            max: true
            min: true
            show: true
            values: true
          nullPointMode: 'null'
          span: 6
          targets:
            - expr: 'sum by (instance) (rate(container_cpu_usage_seconds_total{id=~"/system.slice/docker.service"}[$interval]))'
              legendFormat: "{{instance}}"
        - title: Memory
          type: graph
          fill: 0
          legend:
            alignAsTable: true
            avg: true
            max: true
            min: true
            show: true
            total: false
            values: true
          nullPointMode: 'null'
          span: 6
          targets:
            - expr: 'sum by (instance) (container_memory_rss{id=~"/system.slice/docker.service"}[$interval])'
              legendFormat: "RSS {{instance}}"
        - title: IO Read
          type: graph
          fill: 0
          legend:
            alignAsTable: true
            avg: true
            max: true
            min: true
            show: true
            values: true
          nullPointMode: 'null'
          span: 6
          targets:
            - expr: 'sum by (instance) (rate(container_fs_reads_total{id=~"/system.slice/docker.service"}[$interval]))'
              legendFormat: "Reads {{instance}}"
        - title: IO Write
          type: graph
          fill: 0
          legend:
            alignAsTable: true
            avg: true
            max: true
            min: true
            show: true
            values: true
          nullPointMode: 'null'
          span: 6
          targets:
            - expr: 'sum by (instance) (rate(container_fs_writes_total{id=~"/system.slice/docker.service"}[$interval]))'
              legendFormat: "Writes {{instance}}"
        # - title: Network Receive
        #   type: graph
        #   fill: 0
        #   legend:
        #     alignAsTable: true
        #     avg: true
        #     max: true
        #     min: true
        #     show: true
        #     values: true
        #   nullPointMode: 'null'
        #   span: 6
        #   targets:
        #     - expr: 'sum by (instance) (rate(container_network_receive_bytes_total{pod_name=~"master-etcd-.*"}[$interval])) / 125000'
        #       legendFormat: "RX {{instance}}"
        # - title: Network Transmit
        #   type: graph
        #   fill: 0
        #   legend:
        #     alignAsTable: true
        #     avg: true
        #     max: true
        #     min: true
        #     show: true
        #     values: true
        #   nullPointMode: 'null'
        #   span: 6
        #   targets:
        #     - expr: 'sum by (instance) (rate(container_network_transmit_bytes_total{pod_name=~"master-etcd-.*"}[$interval])) / 125000'
        #       legendFormat: "TX {{instance}}"

    - title: master-controllers CPU/Mem/IO/Network
      collapse: true
      height: 200px
      showTitle: true
      panels:
        - title: CPU
          type: graph
          fill: 0
          legend:
            alignAsTable: true
            avg: true
            max: true
            min: true
            show: true
            values: true
          nullPointMode: 'null'
          span: 6
          targets:
            - expr: 'sum by (instance) (rate(container_cpu_usage_seconds_total{container_name=~"master-controllers.*"}[$interval]))'
              legendFormat: "{{instance}}"
        - title: Memory
          type: graph
          fill: 0
          legend:
            alignAsTable: true
            avg: true
            max: true
            min: true
            show: true
            total: false
            values: true
          nullPointMode: 'null'
          span: 6
          targets:
            - expr: 'sum by (instance) (container_memory_rss{container_name=~"master-controllers.*"})'
              legendFormat: "RSS {{instance}}"
        - title: IO Read
          type: graph
          fill: 0
          legend:
            alignAsTable: true
            avg: true
            max: true
            min: true
            show: true
            values: true
          nullPointMode: 'null'
          span: 6
          targets:
            - expr: 'sum by (instance) (rate(container_fs_reads_total{container_name=~"master-controllers.*"}[$interval]))'
              legendFormat: "Reads {{instance}}"
        - title: IO Write
          type: graph
          fill: 0
          legend:
            alignAsTable: true
            avg: true
            max: true
            min: true
            show: true
            values: true
          nullPointMode: 'null'
          span: 6
          targets:
            - expr: 'sum by (instance) (rate(container_fs_writes_total{container_name=~"master-controllers.*"}[$interval]))'
              legendFormat: "Writes {{instance}}"
        - title: Network Receive
          type: graph
          fill: 0
          legend:
            alignAsTable: true
            avg: true
            max: true
            min: true
            show: true
            values: true
          nullPointMode: 'null'
          span: 6
          targets:
            - expr: 'sum by (instance) (rate(container_network_receive_bytes_total{pod_name=~"master-controllers.*"}[$interval])) / 125000'
              legendFormat: "RX {{instance}}"
        - title: Network Transmit
          type: graph
          fill: 0
          legend:
            alignAsTable: true
            avg: true
            max: true
            min: true
            show: true
            values: true
          nullPointMode: 'null'
          span: 6
          targets:
            - expr: 'sum by (instance) (rate(container_network_transmit_bytes_total{pod_name=~"master-controllers.*"}[$interval])) / 125000'
              legendFormat: "TX {{instance}}"



    # - title: API Request Count by Resources (events)
    #   collapse: true
    #   height: 200px
    #   showTitle: true
    #   panels:
    #     - title: events Get
    #       type: graph
    #       fill: 0
    #       nullPointMode: 'null'
    #       targets:
    #         - expr: rate(apiserver_request_count{resource="events",verb="GET"", instance="$apiserver_instance"}[$interval])
    #     - title: events Post
    #       type: graph
    #       fill: 0
    #       nullPointMode: 'null'
    #       targets:
    #         - expr: rate(apiserver_request_count{resource="events",verb="POST", instance="$apiserver_instance"}[$interval])
    #     - title: events Put
    #       type: graph
    #       fill: 0
    #       nullPointMode: 'null'
    #       targets:
    #         - expr: rate(apiserver_request_count{resource="events",verb="PUT", instance="$apiserver_instance"}[$interval])
    #     - title: events Delete
    #       type: graph
    #       fill: 0
    #       nullPointMode: 'null'
    #       targets:
    #         - expr: rate(apiserver_request_count{resource="events",verb="DELETE", instance="$apiserver_instance"}[$interval])
    #
    # - title: API Request Count by Resources (routes)
    #   collapse: true
    #   height: 200px
    #   showTitle: true
    #   panels:
    #     - title: routes Get
    #       type: graph
    #       fill: 0
    #       nullPointMode: 'null'
    #       targets:
    #         - expr: rate(apiserver_request_count{resource="routes",verb="GET", instance="$apiserver_instance"}[$interval])
    #     - title: routes Post
    #       type: graph
    #       fill: 0
    #       nullPointMode: 'null'
    #       targets:
    #         - expr: rate(apiserver_request_count{resource="routes",verb="POST", instance="$apiserver_instance"}[$interval])
    #     - title: routes Put
    #       type: graph
    #       fill: 0
    #       nullPointMode: 'null'
    #       targets:
    #         - expr: rate(apiserver_request_count{resource="routes",verb="PUT", instance="$apiserver_instance"}[$interval])
    #     - title: routes Delete
    #       type: graph
    #       fill: 0
    #       nullPointMode: 'null'
    #       targets:
    #         - expr: rate(apiserver_request_count{resource="routes",verb="DELETE", instance="$apiserver_instance"}[$interval])
    #
    # - title: API Request Count by Resources (nodes)
    #   collapse: true
    #   height: 200px
    #   showTitle: true
    #   panels:
    #     - title: nodes Get
    #       type: graph
    #       fill: 0
    #       nullPointMode: 'null'
    #       targets:
    #         - expr: rate(apiserver_request_count{resource="nodes",verb="GET", instance="$apiserver_instance"}[$interval])
    #     - title: nodes Post
    #       type: graph
    #       fill: 0
    #       nullPointMode: 'null'
    #       targets:
    #         - expr: rate(apiserver_request_count{resource="nodes",verb="POST", instance="$apiserver_instance"}[$interval])
    #     - title: nodes Put
    #       type: graph
    #       fill: 0
    #       nullPointMode: 'null'
    #       targets:
    #         - expr: rate(apiserver_request_count{resource="nodes",verb="PUT", instance="$apiserver_instance"}[$interval])
    #     - title: nodes Delete
    #       type: graph
    #       fill: 0
    #       nullPointMode: 'null'
    #       targets:
    #         - expr: rate(apiserver_request_count{resource="nodes",verb="DELETE", instance="$apiserver_instance"}[$interval])
    #
    # - title: API Request Count by Resources (projects)
    #   collapse: true
    #   height: 200px
    #   showTitle: true
    #   panels:
    #     - title: projects Get
    #       type: graph
    #       fill: 0
    #       nullPointMode: 'null'
    #       targets:
    #         - expr: rate(apiserver_request_count{resource="projects",verb="GET", instance="$apiserver_instance"}[$interval])
    #     - title: projects Post
    #       type: graph
    #       fill: 0
    #       nullPointMode: 'null'
    #       targets:
    #         - expr: rate(apiserver_request_count{resource="projects",verb="POST", instance="$apiserver_instance"}[$interval])
    #     - title: projects Put
    #       type: graph
    #       fill: 0
    #       nullPointMode: 'null'
    #       targets:
    #         - expr: rate(apiserver_request_count{resource="projects",verb="PUT", instance="$apiserver_instance"}[$interval])
    #     - title: projects Delete
    #       type: graph
    #       fill: 0
    #       nullPointMode: 'null'
    #       targets:
    #         - expr: rate(apiserver_request_count{resource="projects",verb="DELETE", instance="$apiserver_instance"}[$interval])
    #
    # - title: API Request Count by Resources (pods)
    #   collapse: true
    #   height: 200px
    #   showTitle: true
    #   panels:
    #     - title: pods Get
    #       type: graph
    #       fill: 0
    #       nullPointMode: 'null'
    #       targets:
    #         - expr: rate(apiserver_request_count{resource="pods",verb="GET", instance="$apiserver_instance"}[$interval])
    #     - title: pods Post
    #       type: graph
    #       fill: 0
    #       nullPointMode: 'null'
    #       targets:
    #         - expr: rate(apiserver_request_count{resource="pods",verb="POST", instance="$apiserver_instance"}[$interval])
    #     - title: pods Put
    #       type: graph
    #       fill: 0
    #       nullPointMode: 'null'
    #       targets:
    #         - expr: rate(apiserver_request_count{resource="pods",verb="PUT", instance="$apiserver_instance"}[$interval])
    #     - title: pods Delete
    #       type: graph
    #       fill: 0
    #       nullPointMode: 'null'
    #       targets:
    #         - expr: rate(apiserver_request_count{resource="pods",verb="DELETE", instance="$apiserver_instance"}[$interval])
    #
    # - title: API Request Count by Resources (Secrets)
    #   collapse: true
    #   height: 200px
    #   showTitle: true
    #   panels:
    #     - title: Secrets Get
    #       type: graph
    #       fill: 0
    #       nullPointMode: 'null'
    #       targets:
    #         - expr: rate(apiserver_request_count{resource="secrets",verb="GET", instance="$apiserver_instance"}[$interval])
    #     - title: Secrets Post
    #       type: graph
    #       fill: 0
    #       nullPointMode: 'null'
    #       targets:
    #         - expr: rate(apiserver_request_count{resource="secrets",verb="POST", instance="$apiserver_instance"}[$interval])
    #     - title: Secrets Put
    #       type: graph
    #       fill: 0
    #       nullPointMode: 'null'
    #       targets:
    #         - expr: rate(apiserver_request_count{resource="secrets",verb="PUT", instance="$apiserver_instance"}[$interval])
    #     - title: Secrets Delete
    #       type: graph
    #       fill: 0
    #       nullPointMode: 'null'
    #       targets:
    #         - expr: rate(apiserver_request_count{resource="secrets",verb="DELETE", instance="$apiserver_instance"}[$interval])
